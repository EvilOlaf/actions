name: "Enable Hetzner VMs"
author: "Igor Pecovnik"
inputs:
  machine-type:
    required: true
  machine-count:
    required: true
  runners-count:
    required: true
  key:
    required: true
  known_hosts:
    required: true
  hetzner_id:
    required: true
  github_token:
    required: true

runs:
  using: "composite"
  steps:

    - name: Install SSH key for storage
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ inputs.key }}
        known_hosts: ${{ inputs.known_hosts }}
        if_key_exists: replace

    - name: Install Homebrew
      shell: bash
      run: |

          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          (echo; echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"') >> ${HOME}/.bash_profile
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install hcloud

    - name: Install Homebrew
      env:
        HCLOUD_TOKEN: ${{ inputs.hetzner_id }}
        GH_TOKEN: ${{ inputs.github_token }}
      shell: bash
      run: |

          # we will use fixed machine names.
          machinenames=("Faerie" "November" "Raven" "Hammer" "Foxtrot" "Papa" "Chimera" "Panther")
          for machinename in "${machinenames[@]}"
          do
              eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
              hcloud server delete $(hcloud server list --output columns=id,name | grep ${machinename} | cut -d" " -f1)
              i=$(( i + 1 ))
              [[ $i == ${{ inputs.machine-count }} ]] && break
          done

    - name: Remove runners
      env:
        GH_TOKEN: ${{ inputs.github_token }}
      shell: bash
      run: |

          # for some reason last added doesn't show up
          #RUNNERS=$(gh api \
          #-H "Accept: application/vnd.github+json" \
          #-H "X-GitHub-Api-Version: 2022-11-28" \
          #"/orgs/${{ github.repository_owner }}/actions/runners?per_page=1000" | \
          #jq -r '.runners[] | select(.labels[].name=="temp")' | jq '.id')

          # get all runners that have label "temp"
          RUNNERS=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "/repos/${{ github.repository_owner }}/os/actions/runners?per_page=1000" | \
          jq -r '.runners[] | select(.labels[].name=="temp")' | jq '.id')

          # remove them
          # while IFS= read -r id; do
          #gh api \
          #--method DELETE \
          #-H "Accept: application/vnd.github+json" \
          #-H "X-GitHub-Api-Version: 2022-11-28" \
          #/orgs/${{ github.repository_owner }}/actions/runners/${id}
          #done <<< $RUNNERS

          # remove them
          while IFS= read -r id; do
          gh api \
          --method DELETE \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/${{ github.repository_owner }}/os/actions/runners/${id}
          done <<< $RUNNERS